<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>JavaScript设计模式之装饰者模式(ReactNative表单验证) | 陈嘉辉的个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在任何系统的开发工作中，表单的验证都是一项必不可少的工作，在ReactNative的开发过程中也不过如此。  现状​         由于ReactNative原生并没有提供表单验证功能，因此只能求助于第三方的一些插件，目前比较常用的ReactNative表单验证插件有以下几种：  react-native-gifted-form react-native-gifted-form是一款非常棒的">
<meta name="keywords" content="设计模式">
<meta property="og:type" content="article">
<meta property="og:title" content="JavaScript设计模式之装饰者模式(ReactNative表单验证)">
<meta property="og:url" content="http://yoursite.com/2018/08/06/JavaScript设计模式之装饰者模式（ReactNatiive表单验证）/index.html">
<meta property="og:site_name" content="陈嘉辉的个人博客">
<meta property="og:description" content="在任何系统的开发工作中，表单的验证都是一项必不可少的工作，在ReactNative的开发过程中也不过如此。  现状​         由于ReactNative原生并没有提供表单验证功能，因此只能求助于第三方的一些插件，目前比较常用的ReactNative表单验证插件有以下几种：  react-native-gifted-form react-native-gifted-form是一款非常棒的">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2018-10-16T15:11:47.831Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JavaScript设计模式之装饰者模式(ReactNative表单验证)">
<meta name="twitter:description" content="在任何系统的开发工作中，表单的验证都是一项必不可少的工作，在ReactNative的开发过程中也不过如此。  现状​         由于ReactNative原生并没有提供表单验证功能，因此只能求助于第三方的一些插件，目前比较常用的ReactNative表单验证插件有以下几种：  react-native-gifted-form react-native-gifted-form是一款非常棒的">
  
    <link rel="alternate" href="/atom.xml" title="陈嘉辉的个人博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">陈嘉辉的个人博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-JavaScript设计模式之装饰者模式（ReactNatiive表单验证）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/08/06/JavaScript设计模式之装饰者模式（ReactNatiive表单验证）/" class="article-date">
  <time datetime="2018-08-06T04:01:24.000Z" itemprop="datePublished">2018-08-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      JavaScript设计模式之装饰者模式(ReactNative表单验证)
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p> 在任何系统的开发工作中，表单的验证都是一项必不可少的工作，在ReactNative的开发过程中也不过如此。</p>
</blockquote>
<h3 id="现状"><a href="#现状" class="headerlink" title="现状"></a>现状</h3><p>​         由于ReactNative原生并没有提供表单验证功能，因此只能求助于第三方的一些插件，目前比较常用的ReactNative表单验证插件有以下几种：</p>
<ol>
<li><p><a href="https://github.com/FaridSafi/react-native-gifted-form#readme" target="_blank" rel="noopener"><strong>react-native-gifted-form</strong></a></p>
<p>react-native-gifted-form是一款非常棒的ReactNative表单验证插件，页面效果非常酷炫，上手也不是很难；但是该项目作者已经很长时间没有维护，并且表单控件只能使用该插件提供的一些控件。</p>
</li>
<li><p><a href="https://github.com/gcanti/tcomb-form-native" target="_blank" rel="noopener"><strong>tcomb-form-native</strong></a></p>
<p>tcomb-form-native是一款非常容易上手的ReactNative表单验证插件，star也达到了将近3k；同样它的缺点也是表单控件只能使用该插件提供的一些控件，并且表单控件的效果与我们的需求差异很大。</p>
</li>
<li><p><a href="https://github.com/react-component/form" target="_blank" rel="noopener"><strong>rc-form</strong></a></p>
<p>rc-form是antd所推荐的一款表单验证插件，它支持ReactNative，可以使用自己封装的表单控件；但是看完官方给出的demo之后，完全懵逼，瞬间感觉遇到了一块硬骨头。</p>
</li>
</ol>
<h3 id="取舍"><a href="#取舍" class="headerlink" title="取舍"></a>取舍</h3><p>​        以上三种表单验证插件都是非常棒的，各有优缺点，关于要使用哪一种完全取决于自己的业务需求，由于目前的业务需求，我选择了<strong>rc-form</strong>。</p>
<h3 id="rc-from-for-ReactNative"><a href="#rc-from-for-ReactNative" class="headerlink" title="rc-from for ReactNative"></a>rc-from for ReactNative</h3><p>先来看下官方给出的<a href="https://github.com/react-component/form/blob/master/examples/react-native/App.js" target="_blank" rel="noopener">demo</a>，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">import React from &apos;react&apos;</span><br><span class="line">import PropTypes from &apos;prop-types&apos;</span><br><span class="line">import &#123;</span><br><span class="line">  StyleSheet,</span><br><span class="line">  Button,</span><br><span class="line">  Dimensions,</span><br><span class="line">  TextInput,</span><br><span class="line">  Text,</span><br><span class="line">  View,</span><br><span class="line">  Alert,</span><br><span class="line">&#125; from &apos;react-native&apos;</span><br><span class="line"></span><br><span class="line">import &#123; createForm &#125; from &apos;rc-form&apos;</span><br><span class="line"></span><br><span class="line">const &#123; width &#125; = Dimensions.get(&apos;window&apos;)</span><br><span class="line">const styles = StyleSheet.create(&#123;</span><br><span class="line">  container: &#123;</span><br><span class="line">    flex: 1,</span><br><span class="line">    backgroundColor: &apos;#fff&apos;,</span><br><span class="line">    alignItems: &apos;center&apos;,</span><br><span class="line">    padding: 50,</span><br><span class="line">    justifyContent: &apos;center&apos;,</span><br><span class="line">  &#125;,</span><br><span class="line">  inputView: &#123;</span><br><span class="line">    width: width - 100,</span><br><span class="line">    paddingLeft: 10,</span><br><span class="line">  &#125;,</span><br><span class="line">  input: &#123;</span><br><span class="line">    height: 42,</span><br><span class="line">    fontSize: 16,</span><br><span class="line">  &#125;,</span><br><span class="line">  errorinfo: &#123;</span><br><span class="line">    marginTop: 10,</span><br><span class="line">  &#125;,</span><br><span class="line">  errorinfoText: &#123;</span><br><span class="line">    color: &apos;red&apos;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">class FromItem extends React.PureComponent &#123;</span><br><span class="line">  getError = error =&gt; &#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">      return error.map(info =&gt; &#123;</span><br><span class="line">        return (</span><br><span class="line">          &lt;Text style=&#123;styles.errorinfoText&#125; key=&#123;info&#125;&gt;</span><br><span class="line">            &#123;info&#125;</span><br><span class="line">          &lt;/Text&gt;</span><br><span class="line">        )</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    const &#123; label, onChange, value, error &#125; = this.props</span><br><span class="line">    return (</span><br><span class="line">      &lt;View style=&#123;styles.inputView&#125;&gt;</span><br><span class="line">        &lt;TextInput</span><br><span class="line">          style=&#123;styles.input&#125;</span><br><span class="line">          value=&#123;value || &apos;&apos;&#125;</span><br><span class="line">          label=&#123;`$&#123;label&#125;：`&#125;</span><br><span class="line">          duration=&#123;150&#125;</span><br><span class="line">          onChangeText=&#123;onChange&#125;</span><br><span class="line">          highlightColor=&quot;#40a9ff&quot;</span><br><span class="line">          underlineColorAndroid=&quot;#40a9ff&quot;</span><br><span class="line">        /&gt;</span><br><span class="line">        &lt;View style=&#123;styles.errorinfo&#125;&gt;&#123;this.getError(error)&#125;&lt;/View&gt;</span><br><span class="line">      &lt;/View&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class App extends React.Component &#123;</span><br><span class="line">  static propTypes = &#123;</span><br><span class="line">    form: PropTypes.object.isRequired,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  checkUserNameOne = (value, callback) =&gt; &#123;</span><br><span class="line">    setTimeout(() =&gt; &#123;</span><br><span class="line">      if (value === &apos;15188888888&apos;) &#123;</span><br><span class="line">        callback(&apos;手机号已经被注册&apos;)</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        callback()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, 2000)</span><br><span class="line">  &#125;</span><br><span class="line">  submit = () =&gt; &#123;</span><br><span class="line">    this.props.form.validateFields((error) =&gt; &#123;</span><br><span class="line">      if (error) return</span><br><span class="line">      Alert(&apos;通过了所有验证&apos;) // eslint-disable-line new-cap</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    const &#123; getFieldDecorator, getFieldError &#125; = this.props.form</span><br><span class="line">    return (</span><br><span class="line">      &lt;View style=&#123;styles.container&#125;&gt;</span><br><span class="line">        &lt;Text&gt;简单的手机号验证&lt;/Text&gt;</span><br><span class="line">        &#123;getFieldDecorator(&apos;username&apos;, &#123;</span><br><span class="line">          validateFirst: true,</span><br><span class="line">          rules: [</span><br><span class="line">            &#123; required: true, message: &apos;请输入手机号!&apos; &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              pattern: /^1\d&#123;10&#125;$/,</span><br><span class="line">              message: &apos;请输入正确的手机号!&apos;,</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">              validator: (rule, value, callback) =&gt; &#123;</span><br><span class="line">                this.checkUserNameOne(value, callback);</span><br><span class="line">              &#125;,</span><br><span class="line">              message: &apos;手机号已经被注册!&apos;,</span><br><span class="line">            &#125;,</span><br><span class="line">          ],</span><br><span class="line">        &#125;)(</span><br><span class="line">          &lt;FromItem</span><br><span class="line">            autoFocus</span><br><span class="line">            placeholder=&quot;手机号&quot;</span><br><span class="line">            error=&#123;getFieldError(&apos;username&apos;)&#125;</span><br><span class="line">          /&gt;</span><br><span class="line">        )&#125;</span><br><span class="line">        &lt;Button color=&quot;#40a9ff&quot; onPress=&#123;this.submit&#125; title=&quot;登陆&quot; /&gt;</span><br><span class="line">      &lt;/View&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default createForm()(App)</span><br></pre></td></tr></table></figure>
<p>​        看完这段代码，相信大部分人跟我的感觉是一样的（不就是一个表单验证吗，怎么使用起来这么复杂，让我瞬间怀念起使用Vue的那段日子）。之前做过Vue相关的开发，elementUI和iView中的表单组件使用起来是多么的简洁易懂，怎么到了ReactNative中就变的这么的复杂难懂。先不吐槽了~，来梳理一下这个demo中的思路吧，毕竟思路清晰以后我们还是可以将其再次封装的（毕竟再好用的插件也都是人家进行多次封装之后供我们使用的，这也是一次技术提升的好机会）。</p>
<p>​    我先来讲一下大致的思路，在代码的最后一句，导出了<code>createForm()(App)</code>，createForm是一个React高阶函数，它接收一个React组件（App），在函数内部对该组件进行加工改造，最后返回加工改造之后的新组件。在createForm函数中其将form对象传递给App组件，因此通过this.props.form就可以获取到这个form对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">const &#123; getFieldDecorator, getFieldError &#125; = this.props.form</span><br><span class="line">....</span><br><span class="line">&#123;getFieldDecorator(&apos;username&apos;, &#123;</span><br><span class="line">	validateFirst: true,</span><br><span class="line">	rules: [</span><br><span class="line">		&#123; required: true, message: &apos;请输入手机号!&apos; &#125;,</span><br><span class="line">		&#123;</span><br><span class="line">			pattern: /^1\d&#123;10&#125;$/,</span><br><span class="line">			message: &apos;请输入正确的手机号!&apos;,</span><br><span class="line">         &#125;,</span><br><span class="line">		&#123;</span><br><span class="line">        	validator: (rule, value, callback) =&gt; &#123;</span><br><span class="line">		    	this.checkUserNameOne(value, callback);</span><br><span class="line">			&#125;,</span><br><span class="line">			message: &apos;手机号已经被注册!&apos;,</span><br><span class="line">         &#125;,</span><br><span class="line">	],</span><br><span class="line">&#125;)(</span><br><span class="line">	&lt;FromItem</span><br><span class="line">		autoFocus</span><br><span class="line">		placeholder=&quot;手机号&quot;</span><br><span class="line">		error=&#123;getFieldError(&apos;username&apos;)&#125;</span><br><span class="line">	/&gt;</span><br><span class="line">)&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h4 id="getFieldDecorator-函数"><a href="#getFieldDecorator-函数" class="headerlink" title="getFieldDecorator()函数"></a>getFieldDecorator()函数</h4><p>form提供了<code>getFieldDecorator</code>函数。其函数定义形式为 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getFieldDecorator(fieldName, fieldOption) =&gt; (Component) =&gt; ComponentWithExtraProps</span><br></pre></td></tr></table></figure>
<p>getFieldDecorator函数接收两个参数，分别是</p>
<ul>
<li>fieldName：字段名称</li>
<li>fieldOption：字段操作对象</li>
</ul>
<p><strong>源码</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/** </span><br><span class="line"> *  &#123;getFieldDecorator(name,fieldOption)(&lt;FormItem &#123;...props&#125;/&gt;)&#125;将表单项包装为高阶组件后返回</span><br><span class="line"> *  实现功能同getFieldProps方法，内部也调用getFieldProps方法</span><br><span class="line"> *  与getFieldProps方法不同的是，被封装表单项的props作为this.fieldMeta[name]的originalProps属性</span><br><span class="line"> *  originalProps属性的主要目的存储被封装表单项的onChange事件，fieldOption下无同类事件时，执行该事件</span><br><span class="line"> *  不推荐将value、defaultValue作为表单项组件如FormItem的props属性</span><br><span class="line"> */</span><br><span class="line">getFieldDecorator: function getFieldDecorator(name, fieldOption) &#123;</span><br><span class="line">	var _this = this;</span><br><span class="line">	// 获取需要传递给被修饰元素的属性。包括onChange,value等</span><br><span class="line">    // 同时在该props中设定用于收集元素值得监听事件(onChange)，以便后续做双向数据。</span><br><span class="line">	var props = this.getFieldProps(name, fieldOption);</span><br><span class="line">     return function (fieldElem) &#123;</span><br><span class="line">     	  // 此处fieldStore存储字段数据信息以及元数据信息。</span><br><span class="line">          // 数据信息包括value,errors,dirty等</span><br><span class="line">          // 元数据信息包括initValue,defaultValue，校验规则等。</span><br><span class="line">          var fieldMeta = _this.getFieldMeta(name);</span><br><span class="line">          var originalProps = fieldElem.props;</span><br><span class="line">          ...</span><br><span class="line">          fieldMeta.originalProps = originalProps;</span><br><span class="line">          fieldMeta.ref = fieldElem.ref;</span><br><span class="line">          return _react2[&quot;default&quot;].cloneElement(fieldElem, (0, _extends3[&quot;default&quot;])(&#123;&#125;, props, _this.getFieldValuePropValue(fieldMeta)));</span><br><span class="line">      &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其返回值是一个React高阶函数，接收参数是FormItem自定义组件，在该高阶函数中将onChange以及value传递给FormItem，然后在FormItem组件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">const &#123; label, onChange, value, error &#125; = this.props</span><br><span class="line">return (</span><br><span class="line">	&lt;View style=&#123;styles.inputView&#125;&gt;</span><br><span class="line">		&lt;TextInput</span><br><span class="line">			style=&#123;styles.input&#125;</span><br><span class="line">			value=&#123;value || &apos;&apos;&#125;</span><br><span class="line">			label=&#123;`$&#123;label&#125;：`&#125;</span><br><span class="line">			duration=&#123;150&#125;</span><br><span class="line">			onChangeText=&#123;onChange&#125;</span><br><span class="line">			highlightColor=&quot;#40a9ff&quot;</span><br><span class="line">			underlineColorAndroid=&quot;#40a9ff&quot;</span><br><span class="line">		/&gt;</span><br><span class="line">		&lt;View style=&#123;styles.errorinfo&#125;&gt;&#123;this.getError(error)&#125;&lt;/View&gt;</span><br><span class="line">	&lt;/View&gt;</span><br><span class="line">)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>获取到onChange以及value后，将其绑定在TextInput组件的onChangeText和value上。（TextInput可以替换为其他的组件，但是替换的组件一定要有value和onChange属性）</p>
<h4 id="getFieldError-函数"><a href="#getFieldError-函数" class="headerlink" title="getFieldError()函数"></a>getFieldError()函数</h4><p>form同样还提供了<code>getFieldError</code>函数。其函数定义形式为 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getFieldError(fieldName) =&gt; errors数组</span><br></pre></td></tr></table></figure>
<p>getFieldError函数接收一个参数：</p>
<ul>
<li>fieldName：字段名称（要与getFieldDecorator函数的第一个参数fieldName保持一致）</li>
</ul>
<p><strong>源码</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// 获取this.fields[name][&quot;errors&quot;]错误数据，并剔除没有error.message的错误数据</span><br><span class="line">getFieldError: function getFieldError(name) &#123;</span><br><span class="line">	return (0, _utils.getErrorStrs)(this.getFieldMember(name, &apos;errors&apos;));</span><br><span class="line">&#125;,</span><br><span class="line">// 获取this.fields[name][member]属性数据</span><br><span class="line">getFieldMember: function getFieldMember(name, member) &#123;</span><br><span class="line">	var field = this.getField(name);</span><br><span class="line">	return field &amp;&amp; field[member];</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>其返回值是一个数组，数组中存储的是错误信息，拿到错误信息之后，将其传递给FormItem的error属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&lt;FromItem</span><br><span class="line">	...</span><br><span class="line">	error=&#123;getFieldError(&apos;username&apos;)&#125;</span><br><span class="line">/&gt;</span><br><span class="line">...</span><br><span class="line">// 在FromItem.js中</span><br><span class="line">...</span><br><span class="line">const &#123; label, onChange, value, error &#125; = this.props</span><br><span class="line">return (</span><br><span class="line">	&lt;View style=&#123;styles.inputView&#125;&gt;</span><br><span class="line">		...</span><br><span class="line">		&lt;View style=&#123;styles.errorinfo&#125;&gt;&#123;this.getError(error)&#125;&lt;/View&gt;</span><br><span class="line">	&lt;/View&gt;</span><br><span class="line">)</span><br><span class="line">...</span><br><span class="line">// 返回error信息组件函数</span><br><span class="line">getError = error =&gt; &#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">      return error.map(info =&gt; &#123;</span><br><span class="line">        return (</span><br><span class="line">          &lt;Text style=&#123;styles.errorinfoText&#125; key=&#123;info&#125;&gt;</span><br><span class="line">            &#123;info&#125;</span><br><span class="line">          &lt;/Text&gt;</span><br><span class="line">        )</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>​    在FromItem组件中，获取到error数组对象之后，调用error信息展示函数，该函数返回错误信息展示组件，从而将错误信息展示给用户。</p>
<h3 id="表单组件的封装"><a href="#表单组件的封装" class="headerlink" title="表单组件的封装"></a>表单组件的封装</h3><p>​    要想对render函数进行瘦身，我们首先要从自定义表单项组件入手。上一节我们讲到<code>getFieldDecorator</code>函数接收fieldName字段名称和fieldOption字段操作对象两个参数，并返回一个React高阶函数（该高阶函数的参数就是自定义表单组件），在该高阶函数中将onChange以及value传递给自定义表单项组件并返回一个加工后的组件对象。因此，我们可以将<code>getFieldDecorator</code>函数放到自定义表单组件中去，代码如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// FormItem.js</span><br><span class="line"></span><br><span class="line">import BaseFormItem from &apos;./base-form-item&apos; // 表单项组件基类</span><br><span class="line"></span><br><span class="line">class FromItem extends BaseFormItem &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    const &#123; label, onChange, value, prop, rules, form &#125; = this.props;</span><br><span class="line">    const &#123; getFieldDecorator, getFieldError &#125; = form;</span><br><span class="line">    return (</span><br><span class="line">      &lt;View style=&#123;styles.inputView&#125;&gt;</span><br><span class="line">      	&#123;getFieldDecorator(prop, &#123;rules&#125;)(</span><br><span class="line">      		&lt;TextInput</span><br><span class="line">              style=&#123;styles.input&#125;</span><br><span class="line">              value=&#123;value || &apos;&apos;&#125;</span><br><span class="line">              label=&#123;`$&#123;label&#125;：`&#125;</span><br><span class="line">              duration=&#123;150&#125;</span><br><span class="line">              onChangeText=&#123;onChange&#125;</span><br><span class="line">              highlightColor=&quot;#40a9ff&quot;</span><br><span class="line">              underlineColorAndroid=&quot;#40a9ff&quot;</span><br><span class="line">            /&gt;</span><br><span class="line">            &lt;View style=&#123;styles.errorinfo&#125;&gt;&#123;this.getError(getFieldError(prop))&#125;&lt;/View&gt;</span><br><span class="line">      	)&#125;</span><br><span class="line">      &lt;/View&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    我们可以看到，上面的代码将<code>getFieldDecorator</code>放到了FormItem组件中去，在页面组件中将form对象，prop和rules传递给FormItem组件，然后在FormItem组件中从页面组件传递过来的form对象中取出<code>getFieldDecorator</code>和<code>getFieldError</code>函数，<code>getFieldDecorator</code>函数接收的两个参数fieldName（页面组件传递过来的prop）、fieldOption（页面组件传递过来的rules）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 表单项基类</span><br><span class="line"> */</span><br><span class="line">class BaseFormItem extends Component &#123;</span><br><span class="line">  getError = (error) =&gt; &#123;</span><br><span class="line">    if (error) &#123;</span><br><span class="line">      return error.map(info =&gt; &lt;Text style=&#123;&#123;color: &apos;red&apos;&#125;&#125; key=&#123;info&#125;&gt;&#123;info&#125;&lt;/Text&gt;)</span><br><span class="line">    &#125;</span><br><span class="line">    return null</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    每一个表单子项都会有显示错误信息的方法，为了避免写重复代码，我们将显示错误信息的方法抽离出来，并创建一个基类，将该方法放到基类中，让所有表单项来继承这个基类。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">class App extends React.Component &#123;</span><br><span class="line">	constructor(props) &#123;</span><br><span class="line">        super(props)</span><br><span class="line"></span><br><span class="line">        this.state = &#123;</span><br><span class="line">          rules: &#123; // 定义校验规则</span><br><span class="line">            username: [</span><br><span class="line">              	&#123; required: true, message: &apos;请输入手机号!&apos; &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  pattern: /^1\d&#123;10&#125;$/,</span><br><span class="line">                  message: &apos;请输入正确的手机号!&apos;,</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  validator: (rule, value, callback) =&gt; &#123;</span><br><span class="line">                    this.checkUserNameOne(value, callback);</span><br><span class="line">                  &#125;,</span><br><span class="line">                  message: &apos;手机号已经被注册!&apos;,</span><br><span class="line">                &#125;,</span><br><span class="line">            ],</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    render() &#123;</span><br><span class="line">    	const &#123; form &#125; = this.props</span><br><span class="line">        return (</span><br><span class="line">        	&lt;View&gt;</span><br><span class="line">              &lt;FromItem</span><br><span class="line">              	form=&#123;form&#125;</span><br><span class="line">              	prop=&quot;username&quot;</span><br><span class="line">              	rules=&#123;this.state.rules.username&#125;</span><br><span class="line">                autoFocus</span><br><span class="line">                placeholder=&quot;手机号&quot;</span><br><span class="line">              /&gt;</span><br><span class="line">              &lt;Button color=&quot;#40a9ff&quot; onPress=&#123;this.submit&#125; title=&quot;登陆&quot; /&gt;</span><br><span class="line">      		&lt;/View&gt;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>​    经过改造之后，页面的render函数代码是不是瞬间减少了。但是这个时候我们要考虑另外一个问题，页面中render函数确实被瘦身了，但是表单组件中的render函数却又开始变的臃肿了。如果我们需要来封装一个选择器表单组件，那FormItem中的那段臃肿的代码是不是还要再被重写一遍呢；如果我们后续开发的过程中<strong>rc-form</strong>的实现形式改变了，或者是换了另外一个表单校验插件，那么我们之前封装的表单组件就全部要进行修改；我们封装的表单组件只能用于表单验证，如果想在非表单验证页面上使用的话也是不可以的。综上所述组件与表单验证是强耦合的，我们能不能将<strong>组件</strong>与<strong>表单验证</strong>这两个东西给分开呢？试想一下，组件如果不披表单验证这件外衣它就是一个单纯的组件，如果披了这件外衣，它就是带有表单验证功能的组件，表单验证实现的改变不会影响到组件。怎么才能达到这种理想状态呢？</p>
<h3 id="装饰者模式"><a href="#装饰者模式" class="headerlink" title="装饰者模式"></a>装饰者模式</h3><p>​    绕了一大圈子，终于把本文的重点<strong>装饰者模式</strong>引了出来。</p>
<h4 id="什么是装饰者模式？"><a href="#什么是装饰者模式？" class="headerlink" title="什么是装饰者模式？"></a>什么是装饰者模式？</h4><p>​    装饰模式指的是在不必改变原类文件和使用继承的情况下，动态地扩展一个对象的功能。它是通过创建一个包装对象，也就是装饰来包裹真实的对象。通常情况下要给对象扩展功能使用继承的方式，但是继承的方式并不灵活，还会带来许多问题：一方面会导致超类和子类之间存在强耦合性，当超类改变时，子类也会随之改变。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@startuml</span><br><span class="line">Decorator &lt;|-- ConcreteDecoratorA</span><br><span class="line">Decorator &lt;|-- ConcreteDecoratorB</span><br><span class="line"></span><br><span class="line">Component &lt;|-- Decorator</span><br><span class="line">Component &lt;|-- ConcreteComponent</span><br><span class="line"></span><br><span class="line">Decorator o-- Component</span><br><span class="line"></span><br><span class="line">Component: +Operation()</span><br><span class="line">ConcreteComponent: +Operation()</span><br><span class="line">Decorator: +Operation()</span><br><span class="line">class ConcreteDecoratorA &#123;</span><br><span class="line"> &#123;field&#125; addedState</span><br><span class="line"> &#123;method&#125; Operation()</span><br><span class="line">&#125;</span><br><span class="line">ConcreteDecoratorB: +Operation()</span><br><span class="line">ConcreteDecoratorB: AddedBehavior()</span><br><span class="line"></span><br><span class="line">@enduml</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 表单项装饰函数（详情可参考React高阶组件）</span><br><span class="line"> * @param &#123;*&#125; WrappedComponent 传入React组件对象</span><br><span class="line"> * @returns 经过加工后新的React组件</span><br><span class="line"> */</span><br><span class="line">const formItemDecorator = function formItemDecorator(WrappedComponent) &#123;</span><br><span class="line">  return class extends Component &#123;</span><br><span class="line">    componentWillMount() &#123;</span><br><span class="line">      const &#123; form, prop, rules &#125; = this.props</span><br><span class="line">      const &#123; getFieldDecorator &#125; = form</span><br><span class="line">      this.fieldDecorator = getFieldDecorator(prop, &#123;rules: [...rules]&#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render() &#123;</span><br><span class="line">      const &#123;form, prop&#125; = this.props</span><br><span class="line">      const &#123;getFieldError&#125; = form</span><br><span class="line">      return (</span><br><span class="line">        &lt;View&gt;</span><br><span class="line">          &#123;this.fieldDecorator(&lt;WrappedComponent &#123;...this.props&#125; error=&#123;getFieldError(prop)&#125; /&gt;)&#125;</span><br><span class="line">        &lt;/View&gt;</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//InputItem.js中使用</span><br><span class="line">export default formItemDecorator(InputItem)</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/08/06/JavaScript设计模式之装饰者模式（ReactNatiive表单验证）/" data-id="cjnbvav5b000az0fy8fnkk7mm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/设计模式/">设计模式</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/08/06/JavaScript设计模式之单例模式/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          JavaScript设计模式之单例模式
        
      </div>
    </a>
  
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CNPM/">CNPM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CNPM/" style="font-size: 10px;">CNPM</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/设计模式/" style="font-size: 20px;">设计模式</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/10/16/JavaScript设计模式之模板方法模式/">JavaScript设计模式之模板方法模式</a>
          </li>
        
          <li>
            <a href="/2018/09/25/基于Docker搭建CNPM私有仓库/">基于Docker搭建CNPM私有仓库</a>
          </li>
        
          <li>
            <a href="/2018/09/17/JavaScript设计模式之组合模式/">JavaScript设计模式之组合模式</a>
          </li>
        
          <li>
            <a href="/2018/09/09/JavaScript设计模式之命令模式/">JavaScript设计模式之命令模式</a>
          </li>
        
          <li>
            <a href="/2018/09/04/JavaScript设计模式之发布订阅模式/">JavaScript设计模式之发布订阅模式</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>